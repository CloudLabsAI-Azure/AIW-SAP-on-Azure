# Module 2: Exercise 3: Connect IoT Devices to Azure IoT Hub

## Overview

In this exercise, you will create and connect to the Azure IoT Hub device then start sending telemetry data from devices to Azure IoT Hub.

This exercise includes the following tasks:

* Review the existing IoT Hub.
* Register a device in your IoT hub.
* Launch Raspberry Pi Online simulator.
* Run application on the Pi web simulator.
* Review the telemetry data from Azure IoT Explorer.

## Task 1: Review the existing IoT Hub

In this task, you will explore through the existing IoT Hub and retrieve the connection String of Iothub.

1. Return to the browser tab in which Azure Portal was open. If you have closed the tab, navigate to the URL ```https://portal.azure.com``` to open the Azure portal.

3. Navigate to aiw-sap-iothub-<inject key="DeploymentID" /> resource group and Select the iothub named iothub-<inject key="DeploymentID" /> .

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-iothub.png?raw=true)
   
1. From the IoT hub navigation menu, select **Shared access policies** to review the available policies.

1. Now, select **iothubowner** policy from the list.

1. On the **iothubowner** policy blade, review the **Primary Connection String** value by selecting the eyeball icon next to the value. You will use this connection string value to establish a connection between the **IoT hub** and **Azure IoT Explorer** to view the telemetry data.

## Task 2: Register a device for Pi in your IoT hub.

In this task, you will create an Iothub device for the existing Iot Hub.

1. From the IoT hub navigation menu Select **IoT Devices** under **Explorers**, then select **New** to add a device in your IoT hub.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-iothubdevice.png?raw=true)

1. On the **Create a device**, provide the below name for **Device ID** and leave other values as default then select **Save**. This action creates a device identity for your IoT hub.

   ```
    device01
   ```
  
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-iothubdevice-1.png?raw=true)

1. After the device is created, open the device **device01** from the list in the IoT devices pane.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-iothubdevice-2.png?raw=true)

1. Now, on the **device01** blade, copy the Primary Connection String to notepad as you will need this value later.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-iothubdevice-3.png?raw=true)

## Task 3: Launch Raspberry Pi Online simulator

In this task, you will launch the Raspberry Pi online simulator and configure the existing code to connect to the Iot Hub.
 
1.  Within the provided VM, navigate to the below URL to launch the Raspberry Pi online simulator.
    
   ```
   https://azure-samples.github.io/raspberry-pi-web-simulator/#GetStarted
   ```

1. On the **Overview of Raspberry Pi Simulator** pop-up, review the points and click on **x** to close it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-simulator-1.png?raw=true)

1. Replace the **[Your IoT hub device connection string]** placeholder in Line 15 with the Azure IoT hub device connection string that you noted earlier.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-simulator-2.png?raw=true)

## Task 4: Run application on the Pi web simulator

In this task, you will run the Raspberry Pi online simulator and view the sensor data that is being sent to Iothub. 

1. Select Run or type npm start to run the application.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-simulator-3.png?raw=true)

1. You should see the following output that shows the sensor data and the messages that are sent to your IoT hub.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex2-simulator-4.png?raw=true)

## Task 5: Review the telemetry data from Azure IoT Explorer 

In this task, you will use the Azure IoT Explorer to review the telemetry data sent by the simulated Iot Hub device to Azure IoT Hub.

1. Launch the Azure IoT Explorer application by clicking on **Azure IoT Explorer** shortcut on the virtual machine desktop.

1. Click on **+ Add connection** on the IoT Hub pane.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer.png?raw=true)

1. On the **Add connection string** blade, enter the **IoT Hub Connection string** value to establish a connection between the **IoT hub** and **Azure IoT Explorer**. You can find the connection string value below.

    **Iothub Connection string** : <inject key="IotHubConnectionString" />
    
   >**Note**: You can also find the **Connection string** value at **IoTHubConnectionString** under **Environment Details** tab.
   
1. Click on **Save**

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer-2.png?raw=true)

1. Under the **Devices** pane you can see the **IoT devices** you have connected and registered in the previous task.

1. Click on **device01** from the list of Devices.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer-3.png?raw=true)

1. Select **Telemetry** from the left-hand side menu and click on the **Start** option.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer-4.png?raw=true)

   This enables you to monitor the data being sent to the IoT hub. You are also verifying that the device can connect and communicate with your IoT hub.

1. Within 2-3 minutes you will receive telemetry data and you should be seeing messages displayed similar to the following: Take a look at sample data to review the temperature values. 
    
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer-5.png?raw=true)
  
1. Once you have verified that the IoT hub is receiving the telemetry from the device01 device, press **Stop** and then close **Azure IoT Explorer** application.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-iotexplorer-6.png?raw=true)
   
1. Navigate back to the browser tab in which the Raspberry Pi online simulator was open and click on **Stop** to stop sending the data to Iot Hub.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex3-simulator-5.png?raw=true)
   
   In this exercise, you will review the existing Iot Hub and create an Iot Hub device. You will use the web simulator and configure it to connect to Iot Hub then simulate the device and view the sensor data that is being sent to Iot Hub. Using Azure IoT Explorer, you will also review the telemetry data sent by the simulated device to Azure Iot Hub. 

