# Module 3: Cloud Operations, Governance, Security

# Exercise 4: Azure Backup for SAP  

## Task 1: Create Recovery Service Vault

1. From the Azure portal, search for **Recovery Services vaults** and select it from the list.

1. Click on **+ New** on the **Recovery Services vaults** blade, to create the resource.

1. On the **Basics** tab, under **Project details** enter the following information.

    1. **Subscription**: Select your subscription from the dropdown.
    2. **Resource Group**: Select your resource group from the dropdown.

1. Enter the below value in the **Vault name** field.

   ```
   SAPHANAvault
   ```
    
1. For the **Region** field, select the same region as the resource group.

1. After adding all the values, the final screenshot will look like this.

1. On the **Create Recovery Services vault** blade, click on **Review + Create**.

1. On the **Review + Create** blade, review the details and click on **Create** to create the recovery service vault.

1. Once the deployment is complete, click on **Go to resource** to navigate it.

## Task 2: Configure Private Endpoints for Backup

## Task 2.1: Enable Managed Identity for your vault

1. Select **Identity** under **Settings** from the left-hand side menu of recovery service vault.

1. On the **System assined(Preview)** blade, change the **Status** to **On**.
 
3. Click on **Save** to save the changes.

4. Select **Yes** on the **Enable system assined managed identity** pop-up.

## Task 2.2: Grant permissions to the vault to create required private endpoints

1. Navigate to the **Resource Group** that has recovery vault and select **Access Control (IAM)** from the left-hand side menu.

1. On the **Access Control** blade, click on **+ Add** to add a new role assignment.

1. Noe, select **+ Add role assignment** from the list.

1. On the **Add role assignment** pane, enter the following information.
 
      1. **Role**: Select **Contributor** from the dropdown.
      2. **Assign access to**: as the  and use the Name of the vault as the Principal. 
      3. **Select**: Search for **SAPHANAvault** and select it.
 
1. Select **Save** to add the role assignment.

1. Navigate to the **Resource Group** that has virtual network and select **Access Control (IAM)** from the left-hand side menu.

1. On the **Access Control** blade, click on **+ Add** to add a new role assignment.

1. Noe, select **+ Add role assignment** from the list.

1. On the **Add role assignment** pane, enter the following information.
 
      1. **Role**: Select **Contributor** from the dropdown.
      2. **Assign access to**: as the  and use the Name of the vault as the Principal. 
      3. **Select**: Search for **SAPHANAvault** and select it.
 
1. Select **Save** to add the role assignment.

## Task 2.3: Create Private Endpoints for Azure Backup

1. Navigate to the **Resource Group** and select the recovery service vault named **SAPHANAvault**.

1. Select **Private endpoint connections** under **Settings** from the left-hand side menu of recovery service vault.

1. On the **Private endpoint connections** to create a new endpoint.

1. On the **Basics** tab of **Create a private endpoint** blade, under **Project details** section enter the following information.

    1. **Subscription**: Select your subscription from the dropdown.
    2. **Resource Group**: Select your resource group from the dropdown.

1. Under **Instance details** section of **Create a private endpoint** blade, enter the below value in the **Name** field.

   ```
   Backupendpoint
   ```
    
1. For the **Region** field, select the same region as the resource group from the dropdown.

1. After adding all the values, the final screenshot will look like this.

1. Now, click on **Next : Resource**.

1. On the **Resource** tab, enter the following information.

      1. **Connection method**: Select **Connect to an Azure resource in my directory.**
      2. **Subscription**: Select your subscription from the dropdown.
      3. **Resource type**: Select your resource group from the dropdown.
      4. **Resource**: Select **SAPHANAVault** from the dropdown.
      5. **Target sub-resource**: Select your **Azure Backup** from the dropdown.

1. After adding all the values, the final screenshot will look like this.

1. Click on **Next : Configuration**.

1. On the **Configuration** tab, enter the following information.

     1. **Virtual Network**: Select your Virtual network from the dropdown.
     2. **Subnet**: Select your subnet from the dropdown.

1. Leave other values as default and click on **Review + Create**.

1. On the **Review + Create** blade, review the details and click on **Create** to create the private endpoint.

## Task 2.4: Discover the databases

1. Navigate to the **Resource Group** and select the recovery service vault named **SAPHANAvault**.

1. Select **Backup** under **Getting Started** from the left-hand side menu of recovery service vault.

1. On the **Backup** blade, enter the followin information.

     1. **Where is your workload running?**: Select **Azure** from the dropdown.
     2. **What do you want to backup?**: Select **SAP HANA in Azure VM** from the dropdown.

1. Select **Start Discovery** to intiate the discovery of databases.

1. On the **Select Virtual Machines** blade, select the virtual machine that has **SAP HANA database** installed in it.

1. Now, click on **Discover DBs** on the **Select Virtual Machines** blade to discover the SAP HANA databases on the VM.

1. Click on **Notifications** bar which is at the top right corner of Azure Portal to review the progress of **DB Discovery** action.

1. Once the deployment is succeeded, click on **X** to close the **Notifications** pane.

   > Notice that **Configure Backup** option is enabled on the **Backup** blade.

## Task 2.5: Configure backup

1. Click on **Configure backup** on the **Backup** blade to configure the backup.

1. On the **Configure backup** blade, click **Edit this policy** to edit the backup policy.

1. Enter the below value in the **Policy name** filed on the **Create policy** blade.

   ```
   SAPHANABackuppolicy
   ```

1. Now, on the **Create policy** blade, click on **Edit** which is next to **Full Backup**.

1. On the **Full Backup Policy** blade, review the configurations and click on **OK**.

1. Click on **OK** on the **Create policy** blade to create the policy.

1. Scroll down on the **Configure backup** blade and click on **Add** under **Database** to add the database.

1. On the **Select items to backup** blade, expand the listed **HANA System** and select the database that you want to backup.

1. Click on **OK** on the **Select items to backup** blade to select the databases.

1. On the **Configure backup** blade, click on **Enable backup** to enable backup.

1. Once the deployment is complete, click on **Go to resource** to navigate to it.

## Task 3: Run on Demand backup 



