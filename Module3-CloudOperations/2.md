# Module 3: Cloud Operations, Governance, Security

# Exercise 2:	Configure Azure Monitor for SAP  

## Overview

Azure Monitor for SAP Solutions is an Azure-native monitoring product for customers, running their SAP landscapes on Azure. With Azure Monitor for SAP Solutions, customers can collect telemetry data from Azure infrastructure and databases in one central location and visually correlate telemetry data for faster troubleshooting. It read the SAP data available in the Log Analytics and makes data available for the workbooks to show it in a graphical manner.

> You can find more references about Azure Monitor for SAP Solutions from here: `https://docs.microsoft.com/en-us/azure/virtual-machines/workloads/sap/azure-monitor-overview`

In this exercise, you will review the pre-deployed **Azure Monitor for SAP Solutions** resource that will be used to monitor the SAP HANA instances. You will then review the SAP HANA provider that is being added to the Azure Monitor. The SAP HANA provider connects to the SAP HANA database, pulls telemetry data from the database, and pushes it to the Log Analytics workspace. You will review the CPU and memory metrics of the SAP HANA instances that are being monitored. You will also review the existing alert rules on the data that is being stored in the Log Analytics workspace.

This exercise includes the following tasks:

  * Review the existing Azure Monitor for SAP
  * Review the existing Key vault and Secret
  * Review the pre-configured SAP HANA Provider
  * Review Azure Monitor Dashboard
  * Review the exisitng Alert rules

## Task 1: Review the existing Azure Monitor for SAP

In this task, you will review the **Azure Monitor for SAP Solutions** resource to monitor the SAP HANA instances.

1. Navigate back to the browser tab in which Azure Portal is open and select **SAPHANARG** resource group from the list.

1. Select the **Azure Monitor for SAP Solutions** resource named **SAPMonitor**.

1. On the **Overview** blade of **SAPMonitor**, review the information about the Azure Monitor.

1. Now, click on **X** to close the **Overview** pane of SAPMonitor resource.

## Task 1.1: Create Key vault and Secret

In this task, you will review the pre-created key vault and secret that stores the SAP HANA database password. The secret will be used to access the SAP system securely.

1. Navigate back to **SAPHANARG** resource group and select the key vault named **SAPHANAVault** from the list of resources.

1. On the **Overview** blade of **SAPHANAVault** resource, review the information about the key vault.

1. Select **Secrets** from the left-hand side menu of the key vault.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-keyvault-10.png?raw=true)

1. Select the secret named **SAPHANADBPassword** from the list.

1. On the **SAPHANADBPassword** secret blade, select the version of the secret listed under **CURRENT VERSION** section.

1. On the **Secret Version** blade, review the properties of the secret.

## Task 1.2: Add SAP HANA Provider to the Azure Monitor

In this task, you will add the **SAP HANA** provider to the Azure Monitor to enable data collection from the SAP HANA database. The SAP HANA provider connects to the SAP HANA database over SQL port, pulls telemetry data from the database, and pushes it to the Log Analytics workspace.

> Info: The SAP HANA provider collects data every 1 minute from the SAP HANA database.

1. Navigate back to the **SAPHANARG** resource group and select the resource **SAPMonitor**.

1. Select **Providers** under **Settings** from the left-hand side menu.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-1.png?raw=true)

1. On the **Providers** blade of **SAPMonitor**, verfiry that **SAPHANAProvider** is listed.
   
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-9.png?raw=true)
   
1. Select the **SAP HANA** link on the providers blade to open it.

## Task 2: Review Azure Monitor Dashboard

In this task, you will view the detailed utilization of CPU and Memory of the monitored SAP HANA instance. You will also review the backup status of the database. 

1. Select **SAP HANA** under **Monitoring** from the left-hand side menu of SAPMonitor.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-11.png?raw=true)

1. Select **HDB / 02** SAP HANA instance that is available under **Monitored SAP HANA Instances**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-12.png?raw=true)
   
   > Note: If you are not able the view the provider on the Providers blade, click on Refresh to fetch the recent results.
   
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-13.png?raw=true)

1. On the **Overview** blade, review that the server with heavy load has been listed. You can also take a look at the CPU and Memory metrics of the SAP HANA instance.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-14.png?raw=true)
   
   > You can also alter the time interval by choosing **Timeframe**, then selecting the interval, and then review the CPU and Memory metrics of the SAP HANA instance.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-14.1.png?raw=true)

1. Now, expand the instance listed that is available under **Instance Overview**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-15.png?raw=true)

1. Notice the **Services** available under the SAP HANA instance and review the status of the services.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-16.png?raw=true)

1. Select the **Utilization** blade and review the **CPU** timeline of the SAP HANA server.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-17.png?raw=true)

1. Click on **Timeframe** and selecting the interval as **24 hours** from the dropdown to review the **CPU** metrics of one day. 

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-17.1.png?raw=true)
   
1. On the same tab, you can have the detailed **CPU** utilization with MAX touched so far.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-18.png?raw=true)

1. Select **Memory** under **Type** on the **Utilization** blade to review the **Memory** usage metrics.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-19.png?raw=true)

1. On selecting the **Memory** button, we can see the Memory timeline for the Server.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-20.png?raw=true)
  
1. You can see the detailed utilization of the **Memory** on HANA and MAX touched so far on the **Utilization** tab.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-21.png?raw=true)
   
1. Select the **Backup** tab on the **SAP HANA** blade and review the backup items.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex2-saphanaprovider-22.png?raw=true)

## Task 3: Create Alerts 

In this task, you will create an alert that will check the status of the SAP HANA system and triggers the action to send an email notification to you if the SAP HANA system is inactive.

## Task 3.1: Create Action Group

In this task, you will create an action group in Azure Monitor that will send an email notification to you based on the condition added in the alert.

1. From the Azure portal, search for **Monitor** and select it from the list.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-1.png?raw=true)

1. Select **Alerts** from the left-hand side menu of the Monitor.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-2.png?raw=true)

1. Now, click on **Manage actions** to create a new action group.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-3.png?raw=true)

1. On the **Manage actions** blade, verify that **SAPActiongroup** is listed and select it to open the action group.

1. review the information about the **SAPActiongroup** on the blade.

## Task 3.2: Setting Up Notification

In this task, you will create an alert that will check the status of the SAP HANA system and send a notification to you if the SAP HANA system is inactive.

1. Navigate back to **Monitor** and select **Alerts** from the left-hand side menu of the Monitor.

1. Click on **+ New alert rule** to create a new rule.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-11.png?raw=true)
   
1. On the **Create alert rule** blade, click on **Select resource** under **Scope** to select the resource.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-12.png?raw=true)

1. On the **Select a resource** blade, enter the following information:

    1. **Filter by subscription**: Select your subscription from the dropdown.
    2. **Filter by resource type**: Select **Log Analytics Workspaces** from the dropdown.
    3. Select the log analytics workspace named sapmon-log-UniqueId.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-13.png?raw=true)

1. Now, click on **Done** to select the Log Analytics Workspace as scope.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-14.png?raw=true)

1. Scroll down on the **Create alert rule** blade and select **Add condition** under **Condition**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-15.png?raw=true)

1. On the **Select a Signal** blade, select **Custom log search**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-16.png?raw=true)

1. Enter the below query in the **Search query** box to check if the system is up and running fine.

   ```
   SapHana_SystemAvailability_CL | where SYSTEM_ACTIVE_s contains "YES" | where TimeGenerated > ago(5m)
   ```
   
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-17.png?raw=true)

1. Now, scroll down on the **Configure signal logic** blade and provide the below information under the **Alert logic** section.

     1. **Based on**: Select **Number of results** from the dropdown.
     2. **Operator**: Select **Equal to** from the dropdown.
     3. **Threshold value**: Enter the value `0`

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-18.png?raw=true)

1. On the **Configure signal logic** blade, enter the below information under the **Condition preview** section to run the query every 5 minutes.

     1. **Period**: Select **5** from the dropdown.
     2. **Frequency**: Select **5** from the dropdown.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-19.png?raw=true)

1. Click on **Done** to save the condition.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-20.png?raw=true)

1. Scroll down on the **Create alert rule** blade, click on **Add action groups** under **Actions** to select the resource.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-21.png?raw=true)

1. Select **Subscription** from the dropdown and select the **action group** that you created earlier.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-22.png?raw=true)

1. Click on **select** to select the action group.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-23.png?raw=true)

1. Under the **Customize actions** section, check the box which is next to **Email subject**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-24.png?raw=true)

1. Enter the below value in the **Subject line** field.

   ```
   SAP HANA is unavailable
   ```
   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-25.png?raw=true)

1. Under the **Alert rule details** section on the **Create alert rule** blade, enter the below information:

    1. **Alert rule name**:  Enter `SAP HANA System Availability`
    2. **Description**: Enter `Alert will be triggered if SAP HANA system is inactive.`
    3. **Severity**: Select **Critical** from the dropdown.
    4. **Enable alert rule upon creation**: Check this box to enable the rule after creating it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-26.png?raw=true)

1. Leave other values as default and click on **Create alert rule** to create the rule.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-27.png?raw=true)

1. On the **Alerts** blade, click on **Manage alerts rules** to view the rule that you created in the step.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-29.png?raw=true)

3. Verify that the alert rule you created earlier is listed.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-30.png?raw=true)
   
   > If you don't see the alert rule, click on **Refresh** on the overview pane to fetch the recent results.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M3-p2-Ex3-alert-28.png?raw=true)


## Summary

In this exercise, you have covered the following:
   
   * Deployed the **Azure Monitor for SAP Solutions** resource to monitor the SAP HANA instances.
   * Added the SAP HANA provider to the Azure Monitor to connect to the SAP HANA database and pull telemetry data from the database.
   * Reviewed the CPU and Memory metrics of the monitored SAP HANA instance.
   * Created an alert to check the status of the SAP HANA system and send a notification to you if the SAP HANA system is inactive.
   
