# Module2: Productivity

## Scenario

Contoso wants to integrate the SAP system and Microsoft Azure to view the SAP ERP data in a Teams channel or an e-mail generated by Outlook. 

To achieve these requirements, you will be configuring a logic app to display the SAP ERP data in Teams and send an email of the SAP data to Outlook at regular intervals.

## Overview

In this exercise, you will configure a logic app to display the SAP ERP data in Teams and send an email of the SAP data to Outlook. Then, you will run the logic app and review the data triggered by the it in Teams and Outlook.

This exercise includes the following tasks:

* Configure the logic app to display SAP ERP data in Teams and send an email to Outlook.
* Run the logic app and review the logic app run. 
* Review the messages in Microsoft Teams.
* Review the generated e-mail in Outlook.

## Task 1: Configure the logic app trigger to display SAP ERP data in Teams

1. Navigate back to the aiw-sap-iothub-<inject key="DeploymentID" /> resource group and select logicapp-sap-teams-<inject key="DeploymentID" />

1. When you select the logic app, the Logic Apps Designer opens. Scroll down to **Templates** and select **Blank Logic App**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex4-logicapp-2.png?raw=true)

1. Select the **All** tab to add the **recurrence** action.

1. In the Logic Apps Designer search box, enter **recurrence**, and select the trigger named **Recurrence**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-1.png?raw=true)

1. Inside the trigger, change these properties as described below to trigger the action every 5 minutes.

   - Interval	: `5`
   - Frequency : Select **minutes** from the dropdown.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-2.png?raw=true)

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Select **HTTP** from the list.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex4-logicapp-9.png?raw=true)

1. Under **Actions**, select **Http** again.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex4-logicapp-10.png?raw=true)
   
1. Now to rename the step, select ellipsis and then **Rename**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex4-logicapp-11.png?raw=true)

1. Replace the existing name **HTTP** with **http_get_request** and select anywhere in the logic app designer to save the name.
   
1. Under the **http_get_request** trigger, enter the following information:
  
   1. Method : Select **GET** from the dropdown.
   1. URI : https://sapes5.sapdevcenter.com/sap/opu/odata/iwbep/GWSAMPLE_BASIC/SalesOrderSet?$top=50
   1. Enter the following Header parameters:
   
       - Accept : application/json;odata=verbose (Enter `Accept` under Key and `application/json;odata=verbose` under value)

   1. Now, scroll down and select **Add Parameter** then **Authentication** from the dropdown.

      ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-3.png?raw=true)

   1. Under Authentication, enter the following infortamion:
       - **Authentication type** : Select **Basic** from the dropdown.
       - **Username** : Enter the username of Es5 demo account which you noted earlier.
       - **Password** : <inject key="AzureAdUserPassword"></inject>  

     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-Ex4-logicapp-14.png?raw=true)

   1. After adding all the values, the final screenshot will look like this:

      ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-4.png?raw=true)
      
1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **Data operations** and select it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-5.png?raw=true)

1. Under **Actions**, select **Parse JSON** to add Parse JSON action.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-6.png?raw=true)

1. Enter the following information in the **Parse JSON** action: 

   - Content:  To Add the **Body** output of the HTTP request, follow below steps

       1. Click inside the edit box of **Content** so that the dynamic content list appears.  
       2. Select **Body** which is under **http_get_request** from dynamic content list.

    ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-7.png?raw=true)

   - Now,  select **Use sample payload to generate schema** to add sales order data.

    ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-8.png?raw=true)
   
   - You will be presented with the below page to enter a sample JSON payload.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-9.png?raw=true)
   
   - Enter the following content and click on **Done**.

     ```
     {
     "d": {
      "results": [
      {
        "__metadata": {
          "id": "https://sapes5.sapdevcenter.com/sap/opu/odata/iwbep/GWSAMPLE_BASIC/SalesOrderSet('0500000000')",
          "uri": "https://sapes5.sapdevcenter.com/sap/opu/odata/iwbep/GWSAMPLE_BASIC/SalesOrderSet('0500000000')",
          "type": "GWSAMPLE_BASIC.SalesOrder"
        },
        "SalesOrderID": "0500000000",
        "Note": "EPM DG: SO ID 0500000000 Deliver as fast as possible",
        "NoteLanguage": "EN",
        "CustomerID": "0100000000",
        "CustomerName": "SAP",
        "CurrencyCode": "USD",
        "GrossAmount": "14385.85",
        "NetAmount": "12088.95",
        "TaxAmount": "2296.90",
        "LifecycleStatus": "C",
        "LifecycleStatusDescription": "Closed",
        "BillingStatus": "P",
        "BillingStatusDescription": "Paid",
        "DeliveryStatus": "D",
        "DeliveryStatusDescription": "Delivered",
        "CreatedAt": "\/Date(1538344800000)\/",
        "ChangedAt": "\/Date(1538949600000)\/",
        "ToBusinessPartner": {
          "__deferred": {
            "uri": "https://sapes5.sapdevcenter.com/sap/opu/odata/iwbep/GWSAMPLE_BASIC/SalesOrderSet('0500000000')/ToBusinessPartner"
          }
        },
        "ToLineItems": {
          "__deferred": {
            "uri": "https://sapes5.sapdevcenter.com/sap/opu/odata/iwbep/GWSAMPLE_BASIC/SalesOrderSet('0500000000')/ToLineItems"
               }
              }
             }
            ]
           }
          }
        ```  

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-10.png?raw=true)

   - After adding all the values, the final screenshot will look like this:

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-11.png?raw=true)

1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **variables** and select it from the list.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-12.png?raw=true)

1. Under **Actions**, select **Initialize variable** to initialize a variable.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-13.png?raw=true)

1. Enter the following information to initialize a variable, so that each row or sales order of the parsed JSON resultset will be stored in it.

   - Name: `ArraySalesOrder`
   - Type: Select **Array** from the dropdown.
   - After adding all the values, the final screenshot will look like this:

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-14.png?raw=true)

1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.
   
1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **Control** and select it from the list.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-15.png?raw=true)

1. Under **Actions**, select **For each** to create for each control.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-16.png?raw=true)

1. To add **For each** control, enter the following information:

   1. Select an output from previous steps: You will be providing the variable **results** from Parse JSON as input for each statement. Perform the below steps to do it:

       1. Click inside the edit box of **Select an output from the previous step** so that the dynamic content list appears.  
       2. Select **results** which is under **Parse JSON** from the dynamic content list.

    ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-17.png?raw=true)
  
   1. Now, select **Add an action** to add new action.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-18.png?raw=true)

   1. Now, under **Choose an Operation**, select the **All** tab.
   1. Search for **Data operations** and select it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-5.png?raw=true)

   1. Under **Actions**, select **Compose** to embed a **Compose** action into the **For each** control.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-19.png?raw=true)

   1. Enter the following information to inputs section of compose action
      ```
      {
        "BillingStatus": "@{items('For_each')?['BillingStatus']}",
        "BillingStatusDescription": "@{items('For_each')?['BillingStatusDescription']} ",
        "ChangedAt": "@{items('For_each')?['ChangedAt']}",
        "CreatedAt": "@{items('For_each')?['CreatedAt']}",
        "CurrencyCode": "@{items('For_each')?['CurrencyCode']}",
        "CustomerID": "@{items('For_each')?['CustomerID']}",
        "CustomerName": "@{items('For_each')?['CustomerName']}",
        "DeliveryStatus": "@{items('For_each')?['DeliveryStatus']}",
        "DeliveryStatusDescription": "@{items('For_each')?['DeliveryStatusDescription']}",
        "GrossAmount": "@{items('For_each')?['GrossAmount']}",
        "LifecycleStatus": "@{items('For_each')?['LifecycleStatus']}",
        "LifecycleStatusDescription": "@{items('For_each')?['LifecycleStatusDescription']}",
        "NetAmount": "@{items('For_each')?['NetAmount']}",
        "Note": "",
        "NoteLanguage": "@{items('For_each')?['NoteLanguage']}",
        "SalesOrderID": "@{items('For_each')?['SalesOrderID']}",
        "TaxAmount": "@{items('For_each')?['TaxAmount']}"
       }
       ```
       After adding the content, the final screenshot will look like this:
       
       ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-20.png?raw=true)
       
   1. Now, select **Add an action** to add a new action.
   1. Now, under **Choose an Operation**, select the **All** tab.
   1. Search for **variables** and select it from the list.

      ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-12.png?raw=true)

   1. Under **Actions**, select **Append to array variable** action to add each record the variable ArraySalesOrder within the “For each” action.

      ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-21.png?raw=true)

   1. Enter the following information to create append to array variable action:
      - Name: Select **ArraySalesOrder** from the dropdown.
      - Value: To add the Outputs of Compose as value, follow the below steps:
      
         1. Click inside the edit box of **Value** so that the dynamic content list appears.  
         2. Select **results** which is under **Compose** from dynamic content list.

            ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-22.png?raw=true)

         3. After adding all the actions for each control, the final screenshot will look like this:

            ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-23.png?raw=true)


1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **Data operations** and select it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-5.png?raw=true)

1. Now, select **Create HTML table** under **actions**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-24.png?raw=true)

1. Enter the following information to create a formatted message out of the **ArraySalesOrders** variable.

   - From: To provide **ArraySalesOrders** variable as input follow the below steps:
   
       1. Click inside the edit box of **Select an output from previous step** so that the dynamic content list appears.  
       2. Select **ArraySalesOrders** which is under **Variables** from the dynamic content list.

      ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-25.png?raw=true)

   - Columns: Automatic
   - After adding all the values, the final screenshot will look like this:

     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-26.png?raw=true)


1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **Microsoft teams** and select it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-27.png?raw=true)

1. Under **Actions**, scroll down and select **Post a message V(3) (Preview)** action to post a message to Teams.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-28.png?raw=true)

1. Click on **Sign in** and use the below credentials to sign in to the team's account.

   * Email/Username: <inject key="AzureAdUserEmail"></inject>
   * Password: <inject key="AzureAdUserPassword"></inject>

1. Under **Post a message V(3) (Preview)** action, enter the following information:

   - Team: Select **SAP on Azure** from the dropdown
   - Channel: Select **General** from the dropdown
   - Message: Enter `SAP with Azure!` and click enter. 
     - Now we need to add the **Output** of Create HTML Table into the Message box so that data will be posted in the teams along with the message. To do so, perform the below steps:
         1. Click inside the edit box of **Message** so that the dynamic content list appears.
         2. In the **Dynamic Content** list, select **See more** which is next to Create HTML Table.
         3. Select **results** which is under **Create HTML Table** from dynamic content list.

          ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-29.png?raw=true)

   - After adding all the values, the final screenshot will look like this:

     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-30.png?raw=true)


1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

1. Select **New step** to add a new step. 

1. Now, under **Choose an Operation**, select the **All** tab.

1. Search for **Office 365 Outlook** and select it.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-31.png?raw=true)

1. Under **actions**, scroll down and select **Send an email (V2)**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-32.png?raw=true)


1. Under the **Send an email (V2)** step, enter the following information
 
   - To: <inject key="AzureAdUserEmail"></inject>
   - Subject: Enter **SAP with Azure!** and click enter. 
   - Body: Enter `Send a mail form SAP!` and click enter.
     - Now we need to add the **Output** of Create HTML Table into the Message box so that data will be posted in the teams along with the message. To do so, perform the below steps:
         1. Click inside the edit box of **Message** so that the dynamic content list appears.
         2. In the **Dynamic Content** list, select **See more** which is next to Create HTML Table.
         3. Select **results** which is under **Create HTML Table** from dynamic content list.

          ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-29.png?raw=true)

   - After adding all the values, the final screenshot will look like this:

     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-33.png?raw=true)

1. Select **Save** on the menu at the top of the Logic Apps Designer to save your changes.

## Task 2: Run the logic app and review the logic app run. 

In this task, you will run the logic app and review the logic app run.

1. Navigate back to the aiw-sap-iothub-<inject key="DeploymentID" /> resource group and select logicapp-sap-teams. 

1. Select **logic app designer** from the left-hand side menu and click on **Run**.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-34.png?raw=true)

1. Once you click on **Run**, the logic app will be triggered for new data.

1. Now, select **overview** from the left-hand side menu then scroll down and select **Run history** tab.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-35.png?raw=true)

1. Select the most recent run and review the logic app run details then, minimize the Azure Portal window.

     ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-36.png?raw=true)

## Task 3: Review the messages in Microsoft Teams

1. Double click on the **Microsoft Teams** desktop shortcut to open it.

1. You can use the below credentials to sign in to the team's account.

   * Email/Username: <inject key="AzureAdUserEmail"></inject>
   * Password: <inject key="AzureAdUserPassword"></inject>

1. Select **Teams** from the left-hand side menu.

1. Review the messages which are being posted by the logic app into the **SAP on Azure** teams channel.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-37.png?raw=true)

1. Note the interval between the messages, it is 5 minutes as we added 5 minutes as the interval in the recurrence action.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-38.png?raw=true)


## Task 4: Review the generated e-mail in Outlook

1. Return to the browser tab in which outlook was open. If you have closed the tab, navigate to this URL `https://outlook.live.com/owa/` and click on **sign in** to sign in to your account.

1. You can use the below credentials to sign in to your account..

   * Email/Username: <inject key="AzureAdUserEmail"></inject>
   * Password: <inject key="AzureAdUserPassword"></inject>

1. Now, open the mail that is being triggered by the logic app and review the sales data.

   ![](https://github.com/CloudLabsAI-Azure/AIW-SAP-on-Azure/blob/main/media/M2-p2-logicapp-39.png?raw=true)


## Summary

In this exercise, you have covered the following:

* Reviewed the existing logic app and configured it to display SAP ERP data in Teams and send an email to Outlook.
* Reviewed the logic app run.
* Reviewed the messages of SAP data triggered by the logic app in Teams.
* Reviewed the generated e-mail of the SAP ERP data in Outlook.

